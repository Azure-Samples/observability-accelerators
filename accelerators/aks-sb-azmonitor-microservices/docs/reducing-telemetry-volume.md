# Reducing Telemetry Volume

The application does not have high scale requirements, though there are a variety of techniques that were used, or could be used, to mitigate storage and cost concerns.

The `valid-cargo-manager` and both Java APIs [implement adaptive sampling by default](https://learn.microsoft.com/en-us/azure/azure-monitor/app/sampling?tabs=net-core-new#configuring-adaptive-sampling-for-aspnet-applications), limiting the number of requests sent to Application Insights. Both services target a specific number of items to export per minute - the actual sampling rate can vary depending on the number of requests the services handle. Given the low scale requirements for the application, sampling does not actually kick in for either of these services with the current test scripts provided. Implementing coordinated fixed-rate sampling across the service architecture would result in reduced storage costs and alleviate retention and rotation concerns. The Java services can implement explicit [fixed rate sampling and sampling overrides](https://learn.microsoft.com/en-us/azure/azure-monitor/app/java-standalone-sampling-overrides#getting-started) via the [`applicationinsights.json`](../src/cargo-processing-api/applicationinsights.json) file, or by supplying specific environment variables that overwrite those properties. The `cargo-processing-validator` can do the same by [providing a percentage](https://github.com/microsoft/ApplicationInsights-node.js/blob/dd7c195f481acdaf39c4abc271424fb750aac81f/README.md#sampling) to the `applicationInsights.defaultClient` in the [`index.ts`](../src/cargo-processing-validator/src/index.ts) file. The `valid-cargo-manager` can [add a sampling rate](https://learn.microsoft.com/en-us/azure/azure-monitor/app/sampling?tabs=net-core-new#configuring-fixed-rate-sampling-for-aspnet-applications) to the [`CreateHostBuilder`](../src/valid-cargo-manager/Program.cs), while the `invalid-cargo-manager` could do so via a `ProbabilitySampler` that can be [passed to tracer classes](https://learn.microsoft.com/en-us/azure/azure-monitor/app/sampling?tabs=net-core-new#configuring-fixed-rate-sampling-for-opencensus-python-applications), rather than the `AlwaysOnSampler` that is [currently used](../src/invalid-cargo-manager/src/service/telemetry_publisher.py).

Especially noisy libraries or specific telemetry items can be targeted with pre-processing functionality that serves to suppress or transform those items. The `valid-cargo-manager` suppresses items from the `Microsoft` namespace that do not meet or exceed the `Warning` severity level, for instance, via the [appsettings.json file](../src/valid-cargo-manager/appsettings.sample.json). The `cargo-processing-validator` includes a [code based pre-processor](../src/cargo-processing-validator/src/index.ts) used to transform outgoing telemetry items before export, as does the [`invalid-cargo-manager`](../src/invalid-cargo-manager/src/service/telemetry_publisher.py). The existing functionalities could be extended to suppress or remove unnecessary properties from additional items, and similar pre-processing functionality could be added to the [Java](https://learn.microsoft.com/en-us/azure/azure-monitor/app/java-standalone-telemetry-processors#getting-started) services via configuration file.

[Log levels](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.logging.loglevel?view=dotnet-plat-ext-7.0) are used to accommodate the fact that certain services automatically instrument telemetry data that is not necessary to capture by default. The `cargo-processing-validator` and `invalid-cargo-manager` services do not emit nearly as much data as the other three services and are [configured to capture all logs](../src/invalid-cargo-manager/src/service/logging_config.py) using DEBUG. The Java based APIs, on the other hand, are configured to [capture all logs of level INFO and above](../src/cargo-processing-api/applicationinsights.json), automatically suppressing debug statements, by default. As mentioned, the `valid-cargo-manager` uses the appsettings.json file to [capture WARNING and above](../src/valid-cargo-manager/appsettings.sample.json) for logs from the Microsoft namespace and INFO for others. These configuration based log levels can be easily reduced to DEBUG to capture additional logs in a debugging scenario. The application uses the default retention policy for all Azure Monitor tables - generally 90 days but certain tables have a 30 day default retention policy, though these could be [set on the Log Analytics resource](https://learn.microsoft.com/en-us/azure/templates/microsoft.operationalinsights/workspaces?pivots=deployment-language-bicep#workspaceproperties) in Bicep or Terraform.

Visit Azure documentation for additional information on [sampling](https://learn.microsoft.com/en-us/azure/azure-monitor/app/sampling?tabs=net-core-new), [pre-processing](https://learn.microsoft.com/en-us/azure/azure-monitor/app/api-filtering-sampling), log levels and [retention](https://learn.microsoft.com/en-us/azure/azure-monitor/app/data-retention-privacy), and more.
